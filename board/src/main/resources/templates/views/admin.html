<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
	<meta charset="UTF-8">
	<title>admin</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light">

	<!-- Header -->
	<header class="border-bottom py-3 bg-light">
		<div class="container d-flex align-items-center">

			<h2 class="mb-0">LOGO</h2>

			<div class="ms-auto d-flex align-items-center gap-2">
				<span class="text-muted small">
					<span sec:authentication="name">user</span>
					/
					<span sec:authentication="authorities">ROLE</span>
				</span>
				<a class="btn btn-outline-dark btn-sm" href="/">home</a>
				<form th:action="@{/logout}" method="post" class="mb-0">
					<button class="btn btn-outline-dark btn-sm" type="submit">Logout</button>
				</form>
			</div>

		</div>
	</header>


	<div class="container py-4">
		<div class="row g-3">

			<!-- サイドバー -->
			<aside class="col-12 col-lg-2">
				<div class="card shadow-sm border admin-sidebar sticky-top">
					<div class="card-body">
						<h6 class="mb-3 fw-bold">管理メニュー</h6>

						<div sec:authorize="hasRole('ADMIN')">
							<div class="list-group">
								<a class="list-group-item list-group-item-action" href="#dashboard"
									data-target="dashboard">ダッシュボード</a>
								<a class="list-group-item list-group-item-action" href="#users"
									data-target="users">ユーザー管理</a>
								<a class="list-group-item list-group-item-action" href="#boards"
									data-target="boards">投稿管理</a>
							</div>

						</div>

						<div sec:authorize="!hasRole('ADMIN')" class="alert alert-warning mt-3 mb-0">
							管理者権限が必要です。
						</div>
					</div>
				</div>
			</aside>

			<!-- メイン -->
			<main class="col-12 col-lg-10">

				<!-- ダッシュボード -->
				<section id="dashboard" class="mb-4" sec:authorize="hasRole('ADMIN')">
					<h4 class="mb-3">ダッシュボード</h4>

					<div class="row g-3">
						<div class="col-12 col-md-4">
							<div class="card shadow-sm">
								<div class="card-body">
									<div class="text-muted small">今日の投稿数</div>
									<div class="fs-3 fw-bold" th:text="${stats.todayBoards}">0</div>
								</div>
							</div>
						</div>

						<div class="col-12 col-md-4">
							<div class="card shadow-sm">
								<div class="card-body">
									<div class="text-muted small">今日の登録者数</div>
									<div class="fs-3 fw-bold" th:text="${stats.todayUsers}">0</div>
								</div>
							</div>
						</div>

						<div class="col-12 col-md-4">
							<div class="card shadow-sm">
								<div class="card-body">
									<div class="text-muted small">未処理の通報</div>
									<div class="fs-3 fw-bold" th:text="${stats.pendingReports}">0</div>
								</div>
							</div>
						</div>
					</div>
				</section>

				<!-- ユーザー管理 -->
				<section id="users" class="mb-4" sec:authorize="hasRole('ADMIN')">
					<h4 class="mb-3">ユーザー管理</h4>

					<div class="card shadow-sm">
						<div class="card-body">

							<!-- 検索 -->
							<form class="row g-2 mb-3" th:action="@{/admin/users}" method="get">
								<div class="col-12 col-md-4">
									<input type="text" class="form-control" name="keyword"
										placeholder="loginId / nickname" th:value="${param.keyword}">
								</div>
								<div class="col-12 col-md-3">
									<select class="form-select" name="role">
										<option value="">全て</option>
										<option value="ROLE_USER" th:selected="${param.role == 'ROLE_USER'}">ユーザー
										</option>
										<option value="ROLE_ADMIN" th:selected="${param.role == 'ROLE_ADMIN'}">
											マネージャー</option>
									</select>
								</div>
								<div class="col-12 col-md-2">
									<button class="btn btn-primary w-100" type="submit">検索</button>
								</div>
							</form>

							<!-- リスト -->
							<div class="table-responsive">
								<table class="table table-hover align-middle">
									<thead>
										<tr>
											<th style="width:80px;">ID</th>
											<th style="width:220px;">LOGIN</th>
											<th style="width:220px;">NICKNAME</th>
											<th style="width:220px;">ACTION</th>
										</tr>
									</thead>
									<tbody>
										<tr th:each="u : ${users}">
											<td th:text="${u.userId}">1</td>
											<td th:text="${u.loginId}">id</td>
											<td th:text="${u.nickname}">nick</td>
											<td class="d-flex gap-2">
												<form th:action="@{/admin/users/{id}/role(id=${u.userId})}"
													method="post" class="mb-0">
													<input type="hidden" name="role" value="ROLE_ADMIN">
													<button class="btn btn-outline-success btn-sm"
														type="submit">マネージャーにする</button>
												</form>

												<form th:action="@{/admin/users/{id}/suspend(id=${u.userId})}"
													method="post" class="d-flex gap-2 align-items-center">

													<select name="days" class="form-select form-select-sm w-auto">
														<option value="1">1日</option>
														<option value="3">3日</option>
														<option value="7">7日</option>
														<option value="30">30日</option>
														<option value="9999">永久</option>
													</select>

													<button class="btn btn-outline-warning btn-sm" type="submit">
														制裁
													</button>
												</form>

											</td>
										</tr>
										<tr th:if="${#lists.isEmpty(users)}">
											<td colspan="5" class="text-muted">ユーザーがいません。</td>
										</tr>
									</tbody>
								</table>
							</div>

						</div>
					</div>
				</section>

				<!-- 投稿管理 -->
				<section id="boards" class="mb-4" sec:authorize="hasRole('ADMIN')">
					<h4 class="mb-3">投稿管理</h4>

					<div class="card shadow-sm">
						<div class="card-body">
							<div class="table-responsive">
								<table class="table table-hover align-middle">
									<thead>
										<tr>
											<th style="width:80px;">投稿ID</th>
											<th>タイトル</th>
											<th style="width:160px;">作成者</th>
											<th style="width:120px;" class="text-end">通報カウント</th>
										</tr>
									</thead>

									<tbody>
										<tr th:each="b : ${boards}" data-type="board"
											th:attr="data-board-id=${b.boardId}">
											<td th:text="${b.boardId}">1</td>
											<td>
												<a class="text-decoration-none js-report-detail reported"
													th:text="${b.title}">
												</a>

											</td>
											<td th:text="${b.userId}">writer</td>
											<td class="text-end" th:text="${b.reportCount}">0</td>
										</tr>

										<tr>
											<td th:if="${#lists.isEmpty(boards)}" colspan="6" class="text-muted">
												投稿がありません。</td>
										</tr>
									</tbody>
								</table>
							</div>

						</div>
					</div>
				</section>

				<!-- コメント管理 -->
				<section id="comments" class="mb-4" sec:authorize="hasRole('ADMIN')">
					<h4 class="mb-3">投稿管理</h4>

					<div class="card shadow-sm">
						<div class="card-body">
							<div class="table-responsive">
								<table class="table table-hover align-middle">
									<thead>
										<tr>
											<th style="width:80px;">投稿ID</th>
											<th>コメント</th>
											<th style="width:160px;">作成者</th>
											<th style="width:120px;" class="text-end">通報カウント</th>
										</tr>
									</thead>

									<tbody>
										<tr th:each="c : ${comments}" data-type="comment"
											th:attr="data-comment-id=${c.commentId}">
											<td th:text="${c.boardId}">1</td>
											<td>
												<a class="text-decoration-none js-report-detail reported" th:text="${#strings.length(c.content) > 10
												          ? #strings.substring(c.content, 0, 10) + '...'
												          : c.content}">
												</a>
											</td>
											<td th:text="${c.userId}">writer</td>
											<td class="text-end" th:text="${c.reportCount}">0</td>
										</tr>

										<tr>
											<td th:if="${#lists.isEmpty(boards)}" colspan="6" class="text-muted">
												コメントがありません。</td>
										</tr>
									</tbody>
								</table>
							</div>

						</div>
					</div>
				</section>

			</main>
		</div>
	</div>

	<div class="modal fade" id="reportDetailModal" tabindex="-1" aria-hidden="true">
		<div class="modal-dialog modal-lg modal-dialog-scrollable">
			<div class="modal-content">

				<div class="modal-header">
					<h5 class="modal-title">投稿詳細</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>

				<div class="modal-body">
					<div class="d-flex flex-wrap gap-2 mb-3">
						<span id="modalTitle">タイトル</span>
					</div>

					<div id="modalContent" class="border rounded p-3 bg-white" style="min-height: 180px;"></div>

					<div class="mt-4">
						<h6 class="fw-bold mb-2">通報内容</h6>
						<div id="modalReports" class="small text-muted">-</div>
					</div>
				</div>

				<div class="modal-footer flex-column align-items-stretch">

					<form id="modalForm" method="post" class="d-flex justify-content-end gap-2">
						<div>
							<span>user</span>
							<input type="checkbox" id="suspendCheck" name="suspend" value="true">
							<select name="days" class="form-select form-select-sm w-auto">
								<option value="1">1日</option>
								<option value="3">3日</option>
								<option value="7">7日</option>
								<option value="30">30日</option>
								<option value="9999">永久</option>
							</select>
						</div>

						<div class="d-flex justify-content-end gap-2">
							<button type="button" class="btn-process btn btn-danger" data-process="resolve">削除</button>
							<button type="button" class="btn-process btn btn-secondary"
								data-process="reject">却下</button>
						</div>
						<input id="inputTargetType" name="targetType" hidden>
						<input id="inputTargetId" name="targetId" hidden>
						<input id="inputUserId" name="userId" hidden>
						<input id="inputAction" name="action" hidden>
					</form>

				</div>

			</div>
		</div>
	</div>

	<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
	<script>
		$(function () {
			$(".admin-sidebar .list-group-item").on("click", function () {
				$(".admin-sidebar .list-group-item").removeClass("active");
				$(this).addClass("active");
			});

			$(".reported").on("click", function () {
				const reportModal = new bootstrap.Modal("#reportDetailModal");
				const $tr = $(this).closest("tr");
				const targetType = $tr.data("type");
				var targetId;

				if (targetType === "board") {
					targetId = $tr.data("board-id");
				} else if (targetType === "comment") {
					targetId = $tr.data("comment-id");
				} else {
					return;
				}

				if (!targetId) return;

				$.get("/admin/" + targetType + "/" + targetId, function (data) {
					console.log(data);
					$("#inputTargetType").val(targetType);
					$("#inputTargetId").val(data.targetId);
					$("#inputUserId").val(data.userId);

					const $ul = $("#modalReports").empty();
					data.list.forEach(r => {
						$ul.append(`<li class="list-unstyled">${r.reason} - ${r.detail ?? ""}</li>`);
					});
					$("#modalTitle").text(data.title ?? (targetType === "comment" ? "コメント" : ""));
					$("#modalContent").html(data.content);
				});

				reportModal.show();
			});

			$(".btn-process").on("click", function () {
				console.log($(this).data("process"));
				$("#inputAction").val($(this).data("process"));
				$("#modalForm").attr("action", `/admin/report/process`).submit();
			});
		});


	</script>
</body>

</html>