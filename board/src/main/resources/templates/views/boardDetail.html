<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="UTF-8">
	<title>掲示板 - 詳細</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light" th:attr="data-board-id=${board.boardId}">
	<!-- Header -->
	<header class="border-bottom py-3 bg-light">
		<div class="container d-flex align-items-center">
			<h2 class="mb-0">LOGO</h2>
			<a class="btn btn-outline-secondary ms-auto" th:href="@{/}">ホームへ</a>
		</div>
	</header>

	<main class="container py-4">

		<div class="d-flex align-items-center justify-content-between">
			<h3 class="mb-0">投稿詳細</h3>

			<div class="d-flex align-items-center gap-2">
				<button class="btn btn-report btn-outline-danger btn-sm" data-type="BOARD" th:attr="data-id=${board.boardId}">通報</button>
				<button class="btn btn-outline-danger btn-sm" th:attr="data-board-id=${board.boardId}" id="btnLike">❤️</button>
				<span id="likeCount" th:text="${board.likeCount}">0</span>
			</div>
		</div>

		<div class="card shadow-sm">
			<div class="card-body">

				<!-- 作成者 / 投稿日 -->
				<div class="row g-3 mb-3">
					<div class="col-md-6">
						<label class="form-label">作成者</label>
						<input type="text" class="form-control" th:value="${board.writerName}" readonly>
					</div>
					<div class="col-md-6">
						<label class="form-label">投稿日</label>
						<input type="text" class="form-control"
							th:value="${#temporals.format(board.createdAt, 'yyyy/MM/dd HH:mm')}" readonly>
					</div>
				</div>

				<div class="mb-3">
					<label class="form-label">タイトル</label>
					<input type="text" class="form-control" th:value="${board.title}" readonly>
				</div>

				<div class="mb-4">
					<label class="form-label">内容</label>
					<div class="form-control bg-white" style="min-height: 260px;" th:utext="${board.content}"></div>
				</div>

				<!-- ボタン -->
				<div class="d-flex justify-content-between align-items-center">
					<a class="btn btn-outline-secondary" th:href="@{/board}">一覧へ</a>

					<div class="d-flex gap-2" th:if="${isOwner}">
						<a class="btn btn-primary" th:href="@{/board/edit/{id}(id=${board.boardId})}">編集</a>

						<form th:action="@{/board/delete/{id}(id=${board.boardId})}" method="post" class="m-0">
							<button type="submit" class="btn btn-danger"
								onclick="return confirm('削除しますか？');">削除</button>
						</form>
					</div>
				</div>

			</div>
		</div>

		<div class="my-4"></div>

		<!-- コメント -->
		<div class="card shadow-sm mb-3">
			<div class="card-body">
				<form method="post" th:action="@{/board/{boardId}/comment(boardId=${board.boardId})}">
					<div class="mb-2">
						<label class="form-label">コメントを書く</label>
						<textarea class="form-control" name="content" rows="3" maxlength="500"
							placeholder="コメントを入力してください" required></textarea>
					</div>
					<div class="d-flex justify-content-end">
						<button type="submit" class="btn btn-primary btn-sm">投稿</button>
					</div>
				</form>
			</div>
		</div>

		<!-- コメント一覧 -->
		<div class="list-group">
			<div class="list-group-item" th:each="c : ${comment}">
				<div id="divComment" class="d-flex justify-content-between align-items-start">
					<div class="me-3 w-100">
						<div class="d-flex align-items-center gap-2">
							<strong th:text="${c.writerId}">ユーザー</strong>
							<small class="text-muted"
								th:text="${#temporals.format(c.createdAt, 'yyyy/MM/dd HH:mm')}">2026/01/25 10:00</small>
						</div>

						<div class="comment-item">
							<p class="mb-2 mt-2 comment-view" th:text="${c.content}">コメント内容</p>
							<button class="btn btn-report btn-outline-danger btn-sm" data-type="COMMENT" th:attr="data-id=${c.commentId}">通報</btn>
							
							<!-- 作成者のみ -->
							<div th:if="${loginId != null and loginId == c.writerId}"
								th:attr="data-comment-id=${c.commentId}" class="comment-owner">

								<div class="d-flex gap-2">
									<button type="button"
										class="btn btn-outline-primary btn-sm btnUpdateToggle">修正</button>
									<form
										th:action="@{/board/{boardId}/comment/{commentId}/delete(boardId=${board.boardId}, commentId=${c.commentId})}"
										method="post" class="m-0 formDeleteComment">
										<button type="submit" class="btn btn-outline-danger btn-sm"
											onclick="return confirm('削除しますか？');">削除</button>
									</form>

									<textarea class="form-control mt-2 taComment d-none" rows="3" maxlength="500"
										th:text="${c.content}"></textarea>

									<div class="d-flex justify-content-end gap-2 mt-2 editButtons d-none">
										<button type="button"
											class="btn btn-outline-secondary btn-sm btnCancle">キャンセル</button>
										<button type="button" class="btn btn-success btn-sm btnUpdate">保存</button>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>

		<!-- modal -->
		<div class="modal fade" id="reportModal" tabindex="-1" aria-hidden="true">
		  <div class="modal-dialog modal-dialog-centered">
		    <div class="modal-content">

		      <div class="modal-header">
		        <h5 class="modal-title">通報</h5>
		        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
		      </div>

		      <div class="modal-body">
		        <form  id="reportForm" method="post">

		          <input type="hidden" name="targetType">
		          <input type="hidden" name="targetId">

		          <div class="mb-3">
		            <label class="form-label">通報理由</label>
		            <select name="reason" class="form-select" required>
		              <option value="">選択してください</option>
		              <option value="SPAM">スパム</option>
		              <option value="ABUSE">暴言・誹謗中傷</option>
		              <option value="ADULT">不適切な内容</option>
		              <option value="COPYRIGHT">著作権侵害</option>
		              <option value="ETC">その他</option>
		            </select>
		          </div>

		          <div class="mb-3">
		            <label class="form-label">詳細（任意）</label>
		            <textarea name="detail" class="form-control" rows="3" placeholder="具体的な内容を入力してください"></textarea>
		          </div>

			      <div class="modal-footer">
			        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
			        <button type="submit" class="btn btn-danger">通報する</button>
			      </div>
		        </form>
		      </div>


		    </div>
		  </div>
		</div>
		
		
	</main>

	<footer class="border-top py-3 text-center text-muted">
	</footer>

	<!-- script -->
	<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

	<script>

		$(function () {
			// like
			$("#btnLike").on("click", function () {
				var boardId = $(this).data("board-id");
				console.log("boardId: " + boardId);
				$.post(`/board/${boardId}/like`, function (result) {
					var count = Number($("#likeCount").text());
					$("#likeCount").text(count + result);
				})
			});
			
			// comment
			$(".btnUpdateToggle").on("click", function () {
				const $wrap = $(this).closest(".comment-owner");
				const $item = $(this).closest(".comment-item");

				$item.find(".comment-view").addClass("d-none");
				$wrap.find(".taComment").removeClass("d-none");
				$wrap.find(".editButtons").removeClass("d-none");
				$wrap.find(".btnUpdateToggle").addClass("d-none");
				$wrap.find(".formDeleteComment").addClass("d-none");
			});

			$(".btnCancle").on("click", function () {
				const $wrap = $(this).closest(".comment-owner");
				const $item = $(this).closest(".comment-item");

				$item.find(".comment-view").removeClass("d-none");
				$wrap.find(".taComment").addClass("d-none");
				$wrap.find(".editButtons").addClass("d-none");
				$wrap.find(".btnUpdateToggle").removeClass("d-none");
				$wrap.find(".formDeleteComment").removeClass("d-none");

			});

			$(".btnUpdate").on("click", function () {
				const $wrap = $(this).closest(".comment-owner");
				const commentId = $wrap.data("comment-id");
				const boardId = $("body").data("board-id");
				const content = $wrap.find(".taComment").val();

				$.post(`/board/${boardId}/comment/${commentId}/update`, {content: content})
					.done(function (result) {

						if (result.update) {
							const $item = $wrap.closest(".comment-item");
							$item.find(".comment-view").text(content).removeClass("d-none");
							$wrap.find(".taComment").addClass("d-none");
							$wrap.find(".editButtons").addClass("d-none");
							$wrap.find(".formDeleteComment").removeClass("d-none");
							$wrap.find(".btnUpdateToggle").removeClass("d-none");

							alert("成功");
						} else {
							alert("失敗");
						}
					})

					.fail(function (xhr) {
						alert("更新に失敗しました。");
					});
			});
			
			// report
			$(".btn-report").on("click", function () {
				const reportModal = new bootstrap.Modal("#reportModal");
				
				const type = $(this).data("type");
			    const id   = $(this).data("id");
			    $("#reportForm input[name=targetType]").val(type);
			    $("#reportForm input[name=targetId]").val(id);	
				
				// console.log(type);
				// console.log(id);
				
				if (type === "BOARD") {
				  $("#reportForm").attr("action", `/board/${id}/report`);
				} else if (type === "COMMENT") {
				  $("#reportForm").attr("action", `/comment/${id}/report`);
				}
				
				// console.log($("#reportForm").attr("action"));

				reportModal.show();
			});
			
		});
	</script>

</body>

</html>