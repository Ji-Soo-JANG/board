<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>signup</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
        rel="stylesheet">
</head>

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

<script>
	var idOk = false;
	var pwOk = false;
	
	function updateSubmitBtn() {
		  if (idOk && pwOk) {
		    $("#btnSubmit").prop("disabled", false).removeAttr("hidden");
		  } else {
		    $("#btnSubmit").prop("disabled", true).attr("hidden", true);
		  }
		}
	
	$(function(){
		$("#btnCheck").on("click", function(e){
			e.preventDefault();

			const userId = $("#inputId").val().trim();
			
			if(!userId){
				alert("IDを入力してください。");
				return;	
			}
			
			$.ajax({
				url: "/signup/check-id",
				type: "GET",
				data: {id: userId},
				dataType: "json",
				success: function(res){
					if(res.available){
						$("#idCheck")
						.text("このIDは使えます。")
						.removeAttr("hidden")
						.css("color", "blue");
						
						idOk = true;
						
					} else{
						$("#idCheck")
						.text("このIDは使えません。")
						.removeAttr("hidden")
						.css("color", "red");
						
						idOk = false;
					}
					
					updateSubmitBtn();
				},
				
				error: function(){
					alert("サーバーにエラーが発生しました。");
				},
				
				complete: function(){
					$("#btnCheck").prop("disabled", true);
				}
			});
		});
		
		$("#inputId").on("input", function(){
			idOk = false;
			updateSubmitBtn();
			$("#btnCheck").prop("disabled", false);
			$("#idCheck").attr("hidden", true);
		})
		
		$("#pwConfirm").on("input", function(){
			pwOk = false;
			const pw = $("#inputPw").val();
			const pwConfirm = $(this).val();
			
			if(pw == pwConfirm){
				$("#pwCheck")
				.text("パスワードが一致します。")
				.css("color", "blue")
				.removeAttr("hidden");
				pwOk = true;
			} else{
				$("#pwCheck")
				.text("パスワードが一致しません。")
				.css("color", "red")
				.removeAttr("hidden");
				pwOk = false;
			}
			updateSubmitBtn();
		})
		
		$("#signupForm").on("submit", function(e){
		  e.preventDefault();

		  $.ajax({
		    url: "/signup",
		    type: "POST",
		    data: {
		      loginId: $("#inputId").val().trim(),
		      password: $("#inputPw").val(),
			  nickname: $("#inputNickname").val().trim()
		    },
		    dataType: "json",
			
		    success: function(res){
		      if(res.success){
		        alert("登録が完了しました。");
				location.href="/login";
		      } else {
		        alert("登録に失敗しました。");
		      }
		    },
			
		    error: function(){
		      alert("サーバーエラーが発生しました。");
		    }
		  });
		});
	});
</script>
<body>

<!-- ===== Header ===== -->
<header class="border-bottom py-3">
  <div class="container d-flex align-items-center">
    <h2 class="me-4 mb-0">LOGO</h2>

  </div>
</header>

<!-- ===== body ===== -->
<main class="container mt-4">
  <div class="row">
	<h1>新規登録</h1>
	<form id="signupForm" method="post" action="/signup">
		<input id="inputId" name="inputId" type="text" class="form-control" placeholder="IDを入力してください">
		<span id="idCheck" hidden></span><br>
		<button id="btnCheck">重複確認</button>
		<input id="inputNickname" name="inputNickname" type="text" class="form-control" placeholder="ニックネーム">
		<input id="inputPw" name="inputPw" type="password" class="form-control" placeholder="パスワード">
		<span id="pwCheck" hidden></span>
		<input id="pwConfirm" type="password" class="form-control" placeholder="パスワード確認">
		<button id="btnSubmit" hidden disabled>登録</button>
	</form>
  </div>
</main>

<!-- ===== Footer ===== -->
<footer class="border-top mt-5 py-3 text-center text-muted">
</footer>

</body>
</html>
